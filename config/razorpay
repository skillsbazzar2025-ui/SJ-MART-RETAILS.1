const Razorpay = require('razorpay');
const crypto = require('crypto');

/**
 * Razorpay Payment Gateway Configuration
 * SJ Mart Retails - Production Ready
 */

// Initialize Razorpay instance
const razorpay = new Razorpay({
    key_id: process.env.RAZORPAY_KEY_ID,
    key_secret: process.env.RAZORPAY_KEY_SECRET
});

/**
 * Create Razorpay Order
 * @param {number} amount - Amount in INR
 * @param {string} receipt - Unique receipt ID
 * @param {object} notes - Additional notes
 */
const createOrder = async (amount, receipt = null, notes = {}) => {
    try {
        const options = {
            amount: amount * 100, // Convert to paise
            currency: 'INR',
            receipt: receipt || `receipt_${Date.now()}`,
            notes: {
                merchant_name: 'SJ Mart Retails',
                ...notes
            }
        };

        const order = await razorpay.orders.create(options);
        return {
            success: true,
            order,
            key_id: process.env.RAZORPAY_KEY_ID
        };
    } catch (error) {
        console.error('❌ Razorpay order creation failed:', error);
        return {
            success: false,
            error: error.message
        };
    }
};

/**
 * Verify Payment Signature
 * @param {string} orderId - Razorpay order ID
 * @param {string} paymentId - Razorpay payment ID
 * @param {string} signature - Razorpay signature
 */
const verifyPayment = (orderId, paymentId, signature) => {
    try {
        const body = orderId + '|' + paymentId;
        const expectedSignature = crypto
            .createHmac('sha256', process.env.RAZORPAY_KEY_SECRET)
            .update(body.toString())
            .digest('hex');

        const isValid = expectedSignature === signature;
        
        return {
            success: isValid,
            message: isValid ? 'Payment verified successfully' : 'Invalid signature'
        };
    } catch (error) {
        console.error('❌ Payment verification failed:', error);
        return {
            success: false,
            error: error.message
        };
    }
};

/**
 * Fetch Payment Details
 * @param {string} paymentId - Razorpay payment ID
 */
const fetchPayment = async (paymentId) => {
    try {
        const payment = await razorpay.payments.fetch(paymentId);
        return {
            success: true,
            payment
        };
    } catch (error) {
        console.error('❌ Fetch payment failed:', error);
        return {
            success: false,
            error: error.message
        };
    }
};

/**
 * Refund Payment
 * @param {string} paymentId - Razorpay payment ID
 * @param {number} amount - Refund amount in INR
 */
const refundPayment = async (paymentId, amount = null) => {
    try {
        const refund = await razorpay.payments.refund(paymentId, {
            amount: amount ? amount * 100 : undefined
        });
        return {
            success: true,
            refund
        };
    } catch (error) {
        console.error('❌ Refund failed:', error);
        return {
            success: false,
            error: error.message
        };
    }
};

/**
 * Get All Payments
 * @param {object} options - Query options
 */
const getAllPayments = async (options = {}) => {
    try {
        const payments = await razorpay.payments.all(options);
        return {
            success: true,
            payments
        };
    } catch (error) {
        console.error('❌ Fetch payments failed:', error);
        return {
            success: false,
            error: error.message
        };
    }
};

module.exports = {
    razorpay,
    createOrder,
    verifyPayment,
    fetchPayment,
    refundPayment,
    getAllPayments
};
